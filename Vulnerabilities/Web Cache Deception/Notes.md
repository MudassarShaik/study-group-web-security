<body><article id="a0d9a63b-2c02-4d2b-b469-d3894cf32fc9" class="page sans"><header><h1 class="page-title">Web Cache Deception Attack</h1></header><div class="page-body"><h3 id="b4c62ac3-cabb-4614-8eb7-f4482bfb816c" class="">Web Cache Deception Attack</h3><p id="c4a2cdd9-b04e-4d17-bfbf-5c5cec406d24" class=""><strong><span style="border-bottom:0.05em solid">Normal Scenerio:</span></strong></p><ul id="ba2f1bce-1b67-4143-a74e-ca1b13ff08ab" class="bulleted-list"><li>Website <a href="http://www.example.com/">http://www.example.com</a> is configured to go through a reverse proxy.</li></ul><ul id="ab167407-4331-4466-bbc8-b9a7398535b0" class="bulleted-list"><li>A dynamic page (after authentication) that is stored on the server and returns personal content of users, such as <a href="http://www.example.com/home.php">http://www.example.com/home.php</a>, will have to create it dynamically per user, since the data is different for each user. This kind of data, or at least its personalized parts, isn't cached.</li></ul><ul id="1bdfe16f-a17a-4a10-9278-bdff7031767e" class="bulleted-list"><li>What's more reasonable and common to cache are static, public files: style sheets (css), scripts (js), text files (txt), images (png, bmp, gif), etc as these files usually don't contain any sensitive information.</li></ul><figure id="f1dc590c-36f0-4559-b77f-4656219ee529" class="image"><a href="https://miro.medium.com/max/625/0*YVcUk4-Qv7lb06L1.jpg"><img style="width:432px" src="https://miro.medium.com/max/625/0*YVcUk4-Qv7lb06L1.jpg"></a></figure><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="c4267ecd-debc-4038-98a6-47b8c05cd3ab"><div style="font-size:1.5em"><span class="icon">ðŸ’¡</span></div><div style="width:100%">All static files that are meant to be public, are cached disregarding their HTTP caching headers.</div></figure><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="11fb49e2-df26-42c4-90b3-5411aea6f44a"><div style="font-size:1.5em"><span class="icon">ðŸ’¡</span></div><div style="width:100%"><strong>Various static file extensions could be used to cache pages:</strong>
aif, aiff, au, avi, bin, bmp, cab, carb, cct, cdf, class, css, doc, dcr, dtd, gcf, gff, gif, grv, hdml, hqx, ico, ini, jpeg, jpg, js, mov, mp3, nc, pct, ppc, pws, swa, swf, txt, vbs, w32, wav, wbmp, wml, wmlc, wmls, wmlsc, xsd, zip</div></figure><p id="4db0aba7-057b-40fd-b462-6fa9d43572e3" class=""><span style="border-bottom:0.05em solid"><strong>Attack Scenerio:</strong></span></p><ul id="0832a9b2-5afd-4c55-b9ab-c1ecca16bef3" class="bulleted-list"><li>A GET request to the URL <a href="http://www.example.com/home.php/non-existent.css">http://www.example.com/home.php</a><mark class="highlight-blue"><strong><a href="http://www.example.com/home.php/non-existent.css">/non-existent.css</a></strong></mark> is made</li></ul><ul id="ad9d2912-d923-4889-8301-32b35d24523b" class="bulleted-list"><li>Depending on its technology and configuration (the URL structure might need to be built slightly different for different servers), the server returns the content of <a href="http://www.example.com/home.php">http://www.example.com/home.php</a>.</li></ul><ul id="11f8e9da-fd70-43da-844b-dfc100ab3515" class="bulleted-list"><li>The URL remains <a href="http://www.example.com/home.php/non-existent.css">http://www.example.com/home.php/non-existent.css</a></li></ul><ul id="08aba61f-e2c0-4ef4-afbf-465f9d17dd98" class="bulleted-list"><li>The HTTP headers will be the same as for accessing <a href="http://www.example.com/home.php">http://www.example.com/home.php</a> directly: same caching headers and same content type (text/html, in this case)</li></ul><p id="32364212-b0b1-408a-8aaf-10f3b8552ef1" class=""><span style="border-bottom:0.05em solid"><strong>Detailed Attack Scenerio:</strong></span></p><ol id="2f4c2d10-5f4f-4af0-b065-dce6a742c5de" class="numbered-list" start="1"><li>Browser requests&nbsp;<a href="http://www.example.com/home.php/non-existent.css">http://www.example.com/home.php/non-existent.css</a>.</li></ol><ol id="2c55f26e-771a-41c5-8208-e3e04483f436" class="numbered-list" start="2"><li>Server returns the content of&nbsp;<a href="http://www.example.com/home.php">http://www.example.com/home.php</a>, most probably with HTTP caching headers that instruct to not cache this page.</li></ol><ol id="07e47a04-845b-4628-9a8b-bc72674a5847" class="numbered-list" start="3"><li>The response goes through the proxy.</li></ol><ol id="4d23fe42-72aa-4056-9559-48f4bc22ac87" class="numbered-list" start="4"><li>The proxy identifies that the file has a css extension.</li></ol><ol id="1e56b00b-849f-44a5-a7d3-e8e82e9bf5d0" class="numbered-list" start="5"><li>Under the cache directory, the proxy creates a directory named home.php, and caches the imposter "CSS" file (non-existent.css) inside.</li></ol><ol id="91131f76-480c-4db0-b5b7-59d682616398" class="numbered-list" start="6"><li>When next time a user requests <span style="border-bottom:0.05em solid">non-existent.css</span> file, reverse proxy will not send that request to the web server, instead, it will serve the user with the data that it had stored in its cache. Thus, the request for static data is not reaching the web server again.</li></ol><p id="e8013033-1caf-4da6-b261-1d6b1a870926" class=""><span style="border-bottom:0.05em solid"><strong>Exploit Scenerio:</strong></span></p><ul id="0bfc9161-3a53-411a-9210-57b54759e521" class="bulleted-list"><li>An attacker who lures a logged-on user to access <a href="http://www.example.com/home.php/logo.png">http://www.example.com/home.php/logo.png</a> will cause this page â€“ containing the user's personal content â€“ to be cached and thus publicly-accessible.</li></ul><ul id="ad9abb61-addf-46b9-915e-9fbcd065f7ae" class="bulleted-list"><li>It could get even worse, if the body of the response contains (for some reason) the session identifier, security answers or CSRF tokens.</li></ul><ul id="70d7cdb5-0750-4205-96b8-4e64dc32ede3" class="bulleted-list"><li>All the attacker has to do now is to access this page on his own and expose this data.</li></ul><figure id="580ff96c-f652-4fd9-b23f-256ece531dd8" class="image"><a href="https://1.bp.blogspot.com/-zDck8_k-E4Y/WLP6c7VCu-I/AAAAAAAAGcI/lHhHh8SgO5cEVQ3iRBCAVPvdd3Fe-YB8ACLcB/s640/Web_Cache_Manipulation.png"><img src="https://1.bp.blogspot.com/-zDck8_k-E4Y/WLP6c7VCu-I/AAAAAAAAGcI/lHhHh8SgO5cEVQ3iRBCAVPvdd3Fe-YB8ACLcB/s640/Web_Cache_Manipulation.png"></a></figure><p id="1acab9f8-04f6-4881-b4fb-cb583711a029" class=""><strong>Information that could be leaked by exploiting this vulnerability:</strong></p><p id="0cb513b5-dd8f-4508-9387-1dec5ddbcf57" class="">Users' first &amp; last names
Account balance
Last four credit card digits
Transactions data
Full passport number
Email address
Home address
Phone number
Any additional information included in vulnerable pages</p><p id="c8ee3234-0087-4136-ad6b-81870012f6f2" class=""><span style="border-bottom:0.05em solid"><strong>Proof of concept:</strong></span></p><figure id="e671cfcb-f431-4813-8773-73caaa5fcdc3"><div class="source"><a href="https://vimeo.com/249130093">https://vimeo.com/249130093</a></div></figure><p id="a041c658-45b7-4c91-b6c6-fbc8d16b661d" class=""><span style="border-bottom:0.05em solid"><strong>Conditions to check Web Cache Deception Attack:</strong></span></p><ol id="803a163a-60d8-4d90-bb89-f693bb6533f3" class="numbered-list" start="1"><li>The victim must be authenticated while accessing the malicious URL</li></ol><ol id="c68a47ad-0199-40fe-aa20-b973c8550ca2" class="numbered-list" start="2"><li>Web cache functionality is set for the web application to cache files by their extensions, disregarding any caching header.</li></ol><ol id="7df3a8dd-a9b3-4cc0-b461-2caf56c12b3a" class="numbered-list" start="3"><li>When accessing a page like&nbsp;<a href="http://www.example.com/home.php/non-existent.css">http://www.example.com/home.php/non-existent.css</a>, the web server will return the content of "home.php" for that URL.</li></ol><p id="9b898b47-e16d-4baf-a2c6-2a34971672bc" class=""><span style="border-bottom:0.05em solid"><strong>Mitigations:</strong></span></p><ol id="93981c2d-aea0-4ee4-afbc-8f2a207a102c" class="numbered-list" start="1"><li>Configure the cache mechanism to cache files only if their HTTP caching headers allow. That will solve the root cause of this issue.</li></ol><ol id="84306d30-8de0-4ec1-8360-ab6e269d1687" class="numbered-list" start="2"><li>Store all static files in a designated directory and cache only that directory.</li></ol><ol id="fbf911c1-45df-49f6-b00d-85f7a5e5d448" class="numbered-list" start="3"><li>If the cache component provides the option, configure it to cache files by their content type.</li></ol><ol id="5ca547c0-f0bf-4980-975f-d580440d0095" class="numbered-list" start="4"><li>Configure the web server so that for pages such as&nbsp;<a href="http://www.example.com/home.php/non-existent.css">http://www.example.com/home.php/non-existent.css</a>, the web server doesnâ€™t return the content of "home.php" with this URL. Instead, for example, the server should respond with a 404 or 302 response.</li></ol><p id="59ee34a2-1b32-4d8e-bb47-c3e3f524af75" class="">
</p><p id="1da38370-36e2-4826-9b4c-8dd95b4a05ef" class="">
</p><p id="5054c1d9-f256-46d6-9dcd-dd0f522e6f1a" class=""><a href="https://www.blackhat.com/docs/us-17/wednesday/us-17-Gil-Web-Cache-Deception-Attack-wp.pdf">https://www.blackhat.com/docs/us-17/wednesday/us-17-Gil-Web-Cache-Deception-Attack-wp.pdf</a></p></div></article></body>
